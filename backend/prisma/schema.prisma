// Hippocrates Dental - Database Schema
// Provider: SQLite (для MVP)
// Multi-Clinic Medical CRM Architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CLINIC (Клиника)
// ============================================
// Container of all medical data.
// Each clinic stores its own ClinicDoctors, ClinicPatients and Appointments.

model Clinic {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  email        String
  phone        String
  address      String?
  city         String
  about        String?
  logo         String?
  heroImage    String? // Главное изображение для страницы клиники
  workingHours String? // JSON as String in SQLite
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  appointments   Appointment[]
  settings       ClinicSettings?
  certificates   Certificate[]
  clinicDoctors  ClinicDoctor[]
  clinicPatients ClinicPatient[]
  notifications  Notification[]
  conversations  Conversation[]

  @@map("clinics")
}

// ============================================
// USER (Пользователь - только для входа)
// ============================================
// Represents login access only.
// Must contain: id, email, phone?, roles (string[]), globalDoctorId?, globalPatientId?
// Relation to GlobalDoctor (optional)
// Relation to GlobalPatient (optional)
// Must have relation: appointmentsCreated → Appointment.createdByUserId

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  phone           String?
  passwordHash    String
  roles           String // JSON array as String in SQLite: ["DOCTOR", "ADMIN", "PARTNER", "CLINIC"]
  globalDoctorId  String?  @unique
  globalPatientId String?  @unique
  status          String   @default("ACTIVE") // PENDING | ACTIVE | SUSPENDED | REJECTED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  globalDoctor        GlobalDoctor?  @relation("UserToGlobalDoctor", fields: [globalDoctorId], references: [id], onDelete: SetNull)
  globalPatient       GlobalPatient? @relation("UserToGlobalPatient", fields: [globalPatientId], references: [id], onDelete: SetNull)
  appointmentsCreated Appointment[]  @relation("AppointmentCreatedBy")
  notifications       Notification[]
  conversations       Conversation[]

  @@index([email])
  @@index([globalDoctorId])
  @@index([globalPatientId])
  @@index([status])
  @@map("users")
}

// ============================================
// GLOBAL DOCTOR (Врач как личность - глобально)
// ============================================
// Identity of a doctor across the entire platform.
// NOT clinic-specific.
// One real human doctor = one GlobalDoctor
// Can work in multiple clinics (multiple ClinicDoctor records)

model GlobalDoctor {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User?          @relation("UserToGlobalDoctor")
  clinicDoctors ClinicDoctor[]

  @@index([firstName, lastName])
  @@map("global_doctors")
}

// ============================================
// CLINIC DOCTOR (Профиль врача в конкретной клинике)
// ============================================
// A doctor inside a specific clinic.
// One doctor in one clinic = one ClinicDoctor record
// Doctor working in 3 clinics = 3 ClinicDoctor records
// Appointments MUST reference clinicDoctorId.

model ClinicDoctor {
  id             String   @id @default(uuid())
  clinicId       String
  globalDoctorId String
  speciality     String? // Специализация врача в этой клинике
  schedule       String? // JSON as String in SQLite - расписание работы
  percent        Float? // Процент от оплаты (если используется)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  globalDoctor GlobalDoctor  @relation(fields: [globalDoctorId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@unique([clinicId, globalDoctorId]) // Один врач может быть только один раз в клинике
  @@index([clinicId])
  @@index([globalDoctorId])
  @@index([isActive])
  @@map("clinic_doctors")
}

// ============================================
// GLOBAL PATIENT (Пациент как личность - глобально)
// ============================================
// Identity of a patient across the entire platform.
// Created when a User registers or manually when syncing patient profiles.
// One real human patient = one GlobalPatient
// Can be treated in multiple clinics (multiple ClinicPatient records)

model GlobalPatient {
  id        String   @id @default(uuid())
  firstName String?
  lastName  String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user           User?           @relation("UserToGlobalPatient")
  clinicPatients ClinicPatient[]

  @@index([phone])
  @@index([email])
  @@map("global_patients")
}

// ============================================
// CLINIC PATIENT (Профиль пациента в конкретной клинике)
// ============================================
// Local medical card inside a specific clinic.
// One patient in one clinic = one ClinicPatient record
// Patient treated in 4 clinics = 4 ClinicPatient records
// Appointments MUST reference clinicPatientId.

model ClinicPatient {
  id               String    @id @default(uuid())
  clinicId         String
  globalPatientId  String
  name             String
  phone            String
  email            String?
  passwordHash     String? // Optional - only for registered patients
  avatar           String?
  dateOfBirth      DateTime?
  gender           String? // male | female | other
  notes            String?
  localMedicalCard String? // Локальная медицинская карта (JSON as String)
  status           String    @default("guest") // "registered" | "guest"
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  globalPatient GlobalPatient  @relation(fields: [globalPatientId], references: [id], onDelete: Cascade)
  appointments  Appointment[]
  notifications Notification[]
  conversations Conversation[]

  @@unique([clinicId, globalPatientId]) // Один пациент может быть только один раз в клинике
  @@index([clinicId])
  @@index([globalPatientId])
  @@index([phone])
  @@index([email])
  @@index([status])
  @@map("clinic_patients")
}

// ============================================
// APPOINTMENT (Приём)
// ============================================
// The connection point of clinic, doctor, and patient.
// Appointments MUST reference clinicDoctorId and clinicPatientId.
// Relations: clinic → Clinic, doctor → ClinicDoctor, patient → ClinicPatient, createdBy → User

model Appointment {
  id                 String    @id @default(uuid())
  clinicId           String
  clinicDoctorId     String
  clinicPatientId    String
  createdByUserId    String // User who created the appointment
  dateTime           DateTime // Appointment date and time
  duration           Int       @default(30) // Duration in minutes
  status             String    @default("pending") // pending | confirmed | completed | cancelled
  notes              String?
  reason             String? // Reason for appointment
  amount             Float? // Payment amount
  registeredAt       DateTime? // Time when patient registered on website (local time)
  cancellationReason String? // Cancellation reason (required if status is cancelled)
  suggestedNewDate   DateTime? // Suggested new date (optional)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  clinic        Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicDoctor  ClinicDoctor  @relation(fields: [clinicDoctorId], references: [id], onDelete: Cascade)
  clinicPatient ClinicPatient @relation(fields: [clinicPatientId], references: [id], onDelete: Cascade)
  createdBy     User          @relation("AppointmentCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([clinicDoctorId])
  @@index([clinicPatientId])
  @@index([createdByUserId])
  @@index([dateTime])
  @@index([status])
  @@map("appointments")
}

// ============================================
// CLINIC SETTINGS (Настройки клиники)
// ============================================

model ClinicSettings {
  id                         String @id @default(uuid())
  clinicId                   String @unique
  timezone                   String @default("Asia/Yerevan") // Часовой пояс
  language                   String @default("ru") // Язык интерфейса (ru | en | am)
  currency                   String @default("AMD") // Валюта (AMD | RUB | USD)
  defaultAppointmentDuration Int    @default(30) // Время приёма по умолчанию (минуты)

  // Настройки уведомлений
  emailNotificationsEnabled Boolean @default(true) // Email уведомления включены
  smsNotificationsEnabled   Boolean @default(false) // SMS уведомления включены
  appointmentReminderHours  Int     @default(24) // Напоминание о приёме (за сколько часов)
  notifyNewAppointments     Boolean @default(true) // Уведомления о новых заявках
  notifyCancellations       Boolean @default(true) // Уведомления об отменах
  notifyConfirmations       Boolean @default(true) // Уведомления о подтверждениях

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@map("clinic_settings")
}

// ============================================
// CERTIFICATE (Сертификат клиники)
// ============================================

model Certificate {
  id                String    @id @default(uuid())
  clinicId          String
  title             String // Название сертификата
  certificateNumber String? // Номер сертификата
  issuedBy          String? // Организация, выдавшая сертификат
  issueDate         DateTime? // Дата выдачи
  expiryDate        DateTime? // Дата окончания действия
  fileUrl           String // URL файла (base64 или путь к файлу)
  fileType          String // Тип файла: pdf, jpg, png
  fileSize          Int? // Размер файла в байтах
  isVerified        Boolean   @default(false) // Верифицирован ли администратором
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([isVerified])
  @@map("certificates")
}

// ============================================
// NOTIFICATION (Уведомление)
// ============================================

model Notification {
  id              String   @id @default(uuid())
  clinicId        String
  clinicPatientId String? // Опционально - для уведомлений пациентов
  userId          String? // Опционально - для уведомлений врачей/админов
  type            String // cancellation | reschedule | reminder | confirmation | new_appointment | other
  title           String
  message         String
  isRead          Boolean  @default(false)
  appointmentId   String? // ID приёма, связанного с уведомлением (опционально)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicPatient ClinicPatient? @relation(fields: [clinicPatientId], references: [id], onDelete: Cascade)
  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([clinicPatientId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// CONVERSATION (Беседа в чате)
// ============================================

model Conversation {
  id              String    @id @default(uuid())
  clinicId        String
  clinicPatientId String? // ID пациента (если чат с пациентом)
  userId          String? // ID врача или сотрудника клиники
  type            String    @default("patient_doctor") // patient_doctor | patient_clinic | system
  lastMessageAt   DateTime? // Время последнего сообщения
  lastMessageText String? // Текст последнего сообщения (для preview)
  isArchived      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicPatient ClinicPatient? @relation(fields: [clinicPatientId], references: [id], onDelete: Cascade)
  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([clinicId])
  @@index([clinicPatientId])
  @@index([userId])
  @@index([lastMessageAt])
  @@map("conversations")
}

// ============================================
// MESSAGE (Сообщение в чате)
// ============================================

model Message {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String // ID отправителя (userId или clinicPatientId)
  senderType     String // patient | doctor | clinic | system
  content        String // Текст сообщения
  imageUrl       String? // URL изображения (если сообщение содержит изображение)
  isRead         Boolean   @default(false)
  readAt         DateTime? // Время прочтения
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}
