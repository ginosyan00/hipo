# üìã PHASE 1: IMPLEMENTATION PLAN (–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω)

> **–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ breaking changes
> **–ü–æ–¥—Ö–æ–¥:** Gradual Replacement - —Å—Ç–∞—Ä–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ–≤–æ–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

---

## üéØ –û–ë–©–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø

### ‚úÖ –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–°—Ç–∞—Ä–æ–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** - –Ω–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
2. **–ù–æ–≤–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É —Ä—è–¥–æ–º —Å–æ —Å—Ç–∞—Ä–æ–π
3. **Zero downtime** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ –≤—Ä–µ–º—è
4. **Rollback –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç** - –º–æ–∂–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É

---

## üìã –ó–ê–î–ê–ß–ò PHASE 1

### ‚úÖ –®–∞–≥ 1.1: –û–±–Ω–æ–≤–∏—Ç—å Prisma Schema (–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–ï–ó —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –î–æ–±–∞–≤–ª—è–µ–º 4 –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏:
   - `GlobalDoctor` (–Ω–æ–≤—ã–π)
   - `ClinicDoctor` (–Ω–æ–≤—ã–π)
   - `GlobalPatient` (–Ω–æ–≤—ã–π)
   - `ClinicPatient` (–ø–æ–∫–∞ –∫–∞–∫ alias, Patient –æ—Å—Ç–∞–µ—Ç—Å—è)

2. –î–æ–±–∞–≤–ª—è–µ–º optional –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏:
   - `User`: `globalDoctorId`, `globalPatientId` (optional, unique)
   - `Appointment`: `clinicDoctorId`, `clinicPatientId` (optional, nullable)

3. **–í–ù–ò–ú–ê–ù–ò–ï:** –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è –ù–ï —É–¥–∞–ª—è–µ–º:
   - `User.specialization`, `licenseNumber`, `experience` - –æ—Å—Ç–∞—é—Ç—Å—è
   - `Appointment.doctorId`, `patientId` - –æ—Å—Ç–∞—é—Ç—Å—è
   - `Patient` —Ç–∞–±–ª–∏—Ü–∞ - –æ—Å—Ç–∞–µ—Ç—Å—è (–ø–æ–∑–∂–µ –ø–µ—Ä–µ–∏–º–µ–Ω—É–µ–º)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Schema –≥–æ—Ç–æ–≤–∞, –Ω–æ —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### ‚úÖ –®–∞–≥ 1.2: –°–æ–∑–¥–∞—Ç—å Migration (–±–µ–∑ breaking changes)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –°–æ–∑–¥–∞–µ–º migration: `npx prisma migrate dev --name add_global_clinic_separation_phase1`
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ:
   - –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã
   - –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
   - –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã (optional)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Migration –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### ‚úÖ –®–∞–≥ 1.3: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã (—Å—Ç–∞—Ä—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –°–æ–∑–¥–∞–µ–º `services/global-doctor.service.js`:
   - `createGlobalDoctorForUser(userId)`
   - `findGlobalDoctorByUserId(userId)`

2. –°–æ–∑–¥–∞–µ–º `services/clinic-doctor.service.js`:
   - `findClinicDoctorForUser(userId, clinicId)`
   - `createClinicDoctor(globalDoctorId, clinicId, data)`
   - `getClinicsForDoctor(globalDoctorId)`

3. –°–æ–∑–¥–∞–µ–º `services/global-patient.service.js`:
   - `createGlobalPatient(data)`
   - `findGlobalPatientByMatch(data)` // phone/email/DOB

4. –°–æ–∑–¥–∞–µ–º `services/clinic-patient.service.js` (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π, –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –∏–∑ patient.service.js –ø–æ–∑–∂–µ):
   - `findClinicPatientForGlobal(globalPatientId, clinicId)`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≥–æ—Ç–æ–≤—ã, —Å—Ç–∞—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç

---

### ‚úÖ –®–∞–≥ 1.4: Data Migration Script (–∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –°–æ–∑–¥–∞–µ–º `scripts/migrate-data-phase1.js`:
   - –ú–∏–≥—Ä–∏—Ä—É–µ—Ç –≤—Å–µ—Ö User (role=DOCTOR) ‚Üí GlobalDoctor + ClinicDoctor
   - –ú–∏–≥—Ä–∏—Ä—É–µ—Ç –≤—Å–µ—Ö Patient ‚Üí GlobalPatient + ClinicPatient
   - –ó–∞–ø–æ–ª–Ω—è–µ—Ç optional –ø–æ–ª—è –≤ Appointment (clinicDoctorId, clinicPatientId)

2. –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)
   - –° –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
   - –° –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è

---

### ‚úÖ –®–∞–≥ 1.5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ:
   - –°—Ç–∞—Ä—ã–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
   - –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
   - Data migration –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
   - –ù–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Phase 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≥–æ—Ç–æ–≤—ã –∫ Phase 2

---

## üìä CHECKLIST PHASE 1

### Database Schema:
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏: GlobalDoctor, ClinicDoctor, GlobalPatient, ClinicPatient
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: User.globalDoctorId, User.globalPatientId (optional)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: Appointment.clinicDoctorId, Appointment.clinicPatientId (optional)
- [ ] –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è –ù–ï —É–¥–∞–ª–µ–Ω—ã
- [ ] Migration —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

### Backend Services:
- [ ] –°–æ–∑–¥–∞–Ω global-doctor.service.js
- [ ] –°–æ–∑–¥–∞–Ω clinic-doctor.service.js
- [ ] –°–æ–∑–¥–∞–Ω global-patient.service.js
- [ ] –°–æ–∑–¥–∞–Ω clinic-patient.service.js (–∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω)
- [ ] –°—Ç–∞—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### Data Migration:
- [ ] –°–∫—Ä–∏–ø—Ç migrate-data-phase1.js —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ User (DOCTOR) –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ GlobalDoctor
- [ ] –í—Å–µ ClinicDoctor —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í—Å–µ Patient –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ GlobalPatient
- [ ] –í—Å–µ ClinicPatient —Å–æ–∑–¥–∞–Ω—ã
- [ ] Appointment.clinicDoctorId –∏ clinicPatientId –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (–≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)

### Testing:
- [ ] Backup —Å–æ–∑–¥–∞–Ω –ø–µ—Ä–µ–¥ migration
- [ ] –°—Ç–∞—Ä—ã–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- [ ] –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã (–Ω–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö)
- [ ] –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å (rollback plan –≥–æ—Ç–æ–≤)

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ:
1. **Backup –ø–µ—Ä–µ–¥ migration!**
   ```bash
   cp backend/prisma/dev.db backend/prisma/dev.db.backup
   ```

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Data migration script –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —à–∞–≥–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### üü° –í–∞–∂–Ω–æ:
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö:** –ü–æ—Å–ª–µ migration –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ

5. **–ò–Ω–¥–µ–∫—Å—ã:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
   - `GlobalDoctor.userId` (unique)
   - `ClinicDoctor.globalDoctorId, clinicId` (composite)
   - `GlobalPatient` (phone, email)
   - `ClinicPatient.globalPatientId, clinicId` (composite)

---

## üö® ROLLBACK PLAN

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

1. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å migration**
2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backup:**
   ```bash
   cp backend/prisma/dev.db.backup backend/prisma/dev.db
   ```
3. **–û—Ç–∫–∞—Ç–∏—Ç—å migration:**
   ```bash
   npx prisma migrate resolve --rolled-back <migration-name>
   ```
4. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É**
5. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å**

---

## üìÖ –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò

- **–®–∞–≥ 1.1:** Schema update ‚Üí 30 –º–∏–Ω—É—Ç
- **–®–∞–≥ 1.2:** Migration ‚Üí 15 –º–∏–Ω—É—Ç
- **–®–∞–≥ 1.3:** –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã ‚Üí 1-2 —á–∞—Å–∞
- **–®–∞–≥ 1.4:** Data migration script ‚Üí 2-3 —á–∞—Å–∞
- **–®–∞–≥ 1.5:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí 1 —á–∞—Å

**–ò—Ç–æ–≥–æ:** ~5-7 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Phase 1:
- ‚úÖ –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- ‚úÖ –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ Phase 2 (Dual-Write)

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å Phase 1?** üöÄ
